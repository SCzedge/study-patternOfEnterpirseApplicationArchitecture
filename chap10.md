# chap10 데이터 원본 아키텍처 패턴

## 테이블 데이터 게이트웨이
- 단일 테이블이나 뷰에 접근하는 모든 sql을 포함하며 테입ㄹ 데이터 게이트웨이 메소드를 호출해 데이터베이스와의 상호작용을 수행할 수 있다.

### 작동원리
- 일반적으로 데이터베이스 CURD로 구성된 간단한 인터페이스를 가지며 상태 비저장이다.
- 테이블 당 하나씩 사용하는 경우가 많으며 간단한 경우에는 모든테이블의 모든 메서드를 처리할 수도 있음.
- 뷰 기반 테이블 데이터 게이트웨이는 업데이트 할 수 없으므로 업데이트 동작이 없으나, 기반 테이블 업데이트시에는 작업 뒤에서 캡슐화 하는것이 바람직

정보를 반환하는 방법  
- 일반적으로 가장 어려운 부분
- 여러 언어에서는 단일값만 반환할 수 있으나, 쿼리중에는 여러행을 반환하는것이 많음.  

1. 간단한 자료구조(ex.map)를 반환하는 방법
  - 데이터베이스 레코드집합을 map으로 복사시 컴파일검사가 없고 인터페이스가 비명시적이므로 권장되지 않으며, 데이터 전송객체를 사용하는것이 나음

2. 쿼리에서 얻은 레코드 집합 반환 방법
  - 인메모리 객체가 sql인터페이스에 대해 알게 되므로 개념상 엉망이되고 데이터베이스를 파일로 대체하기도 어려우므로 비권장됨
  - .NET환경에서는 매우 효과적이며 테이블 모듈과 함께 사용시 적합.
  - 모든 업데이트가 테이블 데이터 게이트웨이를 통해 실행시 반환데이터를 뷰를 기반으로 둘 수 있고 이경우 코드와 데이터베이스간 결합 감소
  
3. 도메인 모델 사용
  - 테이블 데이터 게이트웨이가 도메인 객체를 반환하는 경우 도메인객체와 게이트웨이 간 양방향 의존 발생

### 사용시점
- 게이트웨이 사용 여부 판단 후 방식 결정
- 테이블이나 레코드에 매핑이 쉬우므로 간단하게 사용가능한 데이터베이스 인터페이스 패턴이며 데이터 원본 접근논리 캡슐화에 적합한 위치.
- 테이블 데이터 게이트웨이는 테이블 모듈과 잘 어울리며 테이블 모듈이 작업할 레코드 집합 자료구조 생성이 가능하다.
- 테이블 데이터 게이트웨이는 트랜잭션 스크립트와 사용하는데 적합하며 데이터 행 처리법에 따라 둘 중 선택이 달라진다.
- 데이터 전송객체가 재사용 되지 않는경우 많은 작업이 필요하므로 사용에 주의할것.
- 테이블 데이터 게이트웨이에는 메타데이터를 사용하면서 도메인 객체에 실제 매핑작성시 데이터메퍼가 테이블 데이터 게이트웨이를 통해 상호작용하게하면 효과적이다.
- 테이블 데이터 게이트웨이로 데이터베이스 접근을 캡슐화시 sql이나 프로시져를 사용할때 동일한 인터페이스를 사용할 수 있다.

## 행 데이터 게이트웨이
- 레코드 구조의 레코드와 동힐하게 생겼지만 프로그래밍 언어의 일반적 메커니즘으로 접근간능한 객체이며 데이터 원본 접근에대한 모든 세부사항은 이 인터페이스 너머로 숨겨진다.

### 작동원리
- 행 데이터 게이트웨이는 데이터베이스 행 하나같이 단일레코드의 흉내를 내는객체
- 클라이언트가 행 데이터 게이트웨이에 직접 접근할 수 있게 한 행에 대한 뎅터 저장
- 트랜잭션 스크립트와 잘어울림
- 검색기 객체를 만들어 테이블마다 검색기 클래스 하나와 결과에 대한 게이트웨이 클래스 하나를 사용하는것.
- 행 데이터 게이트웨이와 활성레코드 차이는 도메인 논리여부. 도메인논리 포함시 활성레코드이며 행 데이터 게이트웽는 접근논리만 포함하여야 한다.
- 테이블 뿐 아니라 뷰나 쿼리에도 사용할 수 있으나, 업데이트시 기반 테이블을 업데이트 해야하므로 까다롭다.
- 테이블의 행 데이터 게이트웨이가 두개 이상인경우 하나를 업데이트하면 다른 게이트웨이의 변경점이 취소딘다.
- 메타데이터 매핑을 활용해 코드를 자동생성 할 수 있다.

### 사용시점
- 게이트웨이 필요 여부 결정 후 행데이터 게이트웨이와 테이블 데이터 게이트웨이중 결정해야한다.
- 트랜잭션 스크립트 사용시에 같이 사용하면 데이터베이스 접근 코드를 분리하고 다른 트랜잭션 스크립트에서 쉽게 사용할 수 있다.
- 도메인모델 사용시 매핑이 간단한경우 활성레코드를 사용하고 매핑이 복잡할 경우 데이터메퍼가 더 좋은 선택이다.
- 메타 데이터를 활용해 행 데이터 게이트웨이를 자동으로 생성하고 데이터 매퍼만 직접 작성하면 효과적으로 사용할 수도 있다.
- 트랜잭션 스크립트와 행 데이터 게이트웨이를 같이 사용시 논리를 옮기다보면 행 데이터 게이트웨이가 활성 레코드로 변하는데 비즈니스 논리의 중복이 줄어드므로 바람직하다.

## 활성 레코드
- 활성레코드는 데이터 접근 논리를 도메인 객체에 넣는 가장 합리적인 방식을 사용한다.

### 작동원리
- 활성 레코드의 핵심은 도메인 모델.
- 활성 레코드는 해당 데이터를 대상으로 하는 모든 도메인 논리를 담당.
- 어플리케이션의 모든 도메인논리를 포함할 수 있지만 일부는 트랜잭션스크립트에 포함될 수 있다.
- 활성 레코드의 자료구조는 데이터베이스와 일치하여야하며 어떤 변환도 하면안된다.
- 활성 레코드의 일반적인 메소드
  1. sql 결과 집합 행을 이용해 활성 레코드 인스턴스 생성   
  2. 테이블에 삽입할 새 인스턴스 사용
  3. sql쿼리 래핑하고 활성레코드 객체 반환하는 정적 검색기 메소드
  4. db업데이트 및 활성레코드 데이터 삽입
  5. 필드 얻기 및 설정
  6. 비즈니스 논리 일부 구현
- 행 데이터 게이트웨이와 매우 비슷하지만 행데이터 게이트웨이는 데이터베이스 접근만을 포함하며 활성레코드는 데이터 원본과 도메인논리를 모두 포함한다.
- 검색메서드를 별도 클래스로 분리시 테스트에 편리하다.

### 사용 시점
- 활성 레코드와 데이터 매퍼중 선택하는것이 중요하다. 활성레코드의 핵심 장점은 단순성이다.
- 활성 레코드 객체가 데이터베이스 테이블과 일대일로 대응되는 동형 스키마에서만 잘 작동함.
- 복잡한 비즈니스 논리의 경우 직접관계, 컬렉션, 상송득을 사용하면 어울리지 않으며 이경우 데이터매퍼가 적합하다.
- 활성 레코드 객체 설계가 데이터베이스 설계와 결합되며 이경우 리팩터링에 어려워진다.
- 트랜잭션 스크립트 사용시 코드가 중복되고 스크립트와 테이블 업데이트가 힘들어질때 고려할만하다.
- 트랜잭션 스크립트를 활성 레코드로 리팩터링 시 테이블을 게이트웨이로 래핑 후 점차 옮기는것도 도움이된다.

## 데이터 매퍼
- 인메모리 객체를 데이터베이스와 분리하는 소프트웨어 계층.
- 객체와 데이터베이스 사이에서 데이터를 전송하고 서로 격리하는 역활이다.
- 데이터매퍼는 매퍼의 한 형태이므로 도메인계층에도 알려지지 않는다.

### 작동원리
- 검색기 처리
  객체

### 사용시점
- 데이터베이스 스키마와 객체 모델을 분리해 발전이 가능하다.
- 일반적으로 도메인 모델과 같이 사용하며 사용시 설계, 구축, 테스트에서 데이터베이스를 고려할 필요가 없다.
- 활성 레코드와 비교시 계층이 하나 추가되므로 이는 비즈니스논리가 얼마나 복잡하느냐에 따라 달라진다.
- 






























